<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Editable Labels (Only for Form Builder)</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      vertical-align: top;
    }

    /* Each cell has a label and a plus/minus spinner below it */
    .spinner-cell {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    /* Editable label in Form Builder, read-only for respondents */
    .spinner-label {
      font-size: 12px;
      color: #555;
      cursor: pointer;
      border: 1px dashed transparent;
      padding: 2px;
      user-select: text; /* allow text selection in the builder */
    }
    .spinner-label[contenteditable='true'] {
      border: 1px dashed #555;
      outline: none;
    }

    /* Plus/Minus Spinner Controls */
    .spinner-container {
      display: inline-flex;
      align-items: center;
    }

    .spinner-btn {
      width: 30px;
      height: 30px;
      background: #333;
      color: #fff;
      border: none;
      cursor: pointer;
      outline: none;
      font-size: 16px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
    }
    .spinner-btn:hover {
      background: #555;
    }

    .spinner-value {
      width: 40px;
      height: 30px;
      text-align: center;
      border: 1px solid #ccc;
      margin: 0 2px;
      outline: none;
      font-size: 14px;
    }
  </style>
</head>
<body>

<table id="spinnerTable"></table>

<!-- Required by JotForm widget -->
<script src="https://cdn.jotfor.ms/js/widgetResizer.js"></script>
<script src="https://cdn.jotfor.ms/JotFormCustomWidget.js"></script>

<script>
  let isInEditorMode = false;  // Will become true if we detect the JotForm builder environment

  /**
   * Detect whether we're in the JotForm Form Builder or the live form.
   * - If document.referrer contains 'build.jotform.com', we assume it's Form Builder mode.
   */
  function detectEditorMode() {
    const ref = document.referrer || '';
    // If you have a different domain structure, adjust here
    isInEditorMode = ref.includes('build.jotform.com');
  }

  /**
   * Creates a cell with an editable label (only in Form Builder)
   * plus a plus/minus spinner for numeric input.
   */
  function createLabeledSpinner(labelText, onChange) {
    const cellDiv = document.createElement('div');
    cellDiv.className = 'spinner-cell';

    // The label can be edited only if we're in editor mode
    const labelDiv = document.createElement('div');
    labelDiv.className = 'spinner-label';
    labelDiv.textContent = labelText || 'Click to edit';

    if (isInEditorMode) {
      // Make label editable
      labelDiv.setAttribute('contenteditable', 'true');
      // Update data whenever user finishes editing
      labelDiv.addEventListener('blur', onChange);
    } else {
      // In live form, ensure the label is not editable
      labelDiv.removeAttribute('contenteditable');
    }

    cellDiv.appendChild(labelDiv);

    // Spinner container
    const spinnerContainer = document.createElement('div');
    spinnerContainer.className = 'spinner-container';

    const minusBtn = document.createElement('button');
    minusBtn.className = 'spinner-btn';
    minusBtn.textContent = '-';

    const valueInput = document.createElement('input');
    valueInput.type = 'text';
    valueInput.className = 'spinner-value';
    valueInput.value = '0';  // default

    const plusBtn = document.createElement('button');
    plusBtn.className = 'spinner-btn';
    plusBtn.textContent = '+';

    // Decrement
    minusBtn.addEventListener('click', () => {
      let current = parseInt(valueInput.value, 10) || 0;
      current = Math.max(0, current - 1);
      valueInput.value = current;
      onChange();
    });

    // Increment
    plusBtn.addEventListener('click', () => {
      let current = parseInt(valueInput.value, 10) || 0;
      current = Math.min(999, current + 1);
      valueInput.value = current;
      onChange();
    });

    // Manual input
    valueInput.addEventListener('change', () => {
      let newVal = parseInt(valueInput.value, 10) || 0;
      if (newVal < 0) newVal = 0;
      if (newVal > 999) newVal = 999;
      valueInput.value = newVal;
      onChange();
    });

    spinnerContainer.appendChild(minusBtn);
    spinnerContainer.appendChild(valueInput);
    spinnerContainer.appendChild(plusBtn);
    cellDiv.appendChild(spinnerContainer);

    return cellDiv;
  }

  /**
   * Build a default table with 6 rows x 2 columns.
   * Each label starts as "Label N".
   */
  function createSpinnerTable(rows, cols) {
    const table = document.getElementById('spinnerTable');
    table.innerHTML = ''; // Clear old table

    let labelCount = 1;
    for (let r = 0; r < rows; r++) {
      const row = table.insertRow();
      for (let c = 0; c < cols; c++) {
        const cell = row.insertCell();
        const spinnerEl = createLabeledSpinner(`Label ${labelCount}`, updateFormData);
        labelCount++;
        cell.appendChild(spinnerEl);
      }
    }

    // Immediately reflect data to JotForm
    updateFormData();
  }

  /**
   * Gathers label/value pairs from the table.
   */
  function gatherTableData() {
    const table = document.getElementById('spinnerTable');
    const data = [];

    for (let r = 0; r < table.rows.length; r++) {
      const rowData = [];
      for (let c = 0; c < table.rows[r].cells.length; c++) {
        const spinnerCell = table.rows[r].cells[c].querySelector('.spinner-cell');
        if (!spinnerCell) continue;

        const labelDiv = spinnerCell.querySelector('.spinner-label');
        const valueInput = spinnerCell.querySelector('.spinner-value');

        rowData.push({
          label: labelDiv.textContent,
          value: valueInput.value
        });
      }
      data.push(rowData);
    }
    return data;
  }

  /**
   * Sends partial data to JotForm after any edit.
   */
  function updateFormData() {
    const data = gatherTableData();
    if (window.JFCustomWidget && JFCustomWidget.sendData) {
      JFCustomWidget.sendData({
        value: JSON.stringify(data)
      });
    }
  }

  /**
   * On form submission, send final data.
   */
  function onSubmitForm() {
    const data = gatherTableData();
    if (window.JFCustomWidget && JFCustomWidget.sendSubmit) {
      JFCustomWidget.sendSubmit({
        value: JSON.stringify(data)
      });
    }
  }

  // Determine if we're in form builder or live form, then build table
  if (window.JFCustomWidget) {
    // When widget is ready
    JFCustomWidget.subscribe('ready', function() {
      detectEditorMode();
      createSpinnerTable(6, 2); // Build default 6x2
    });

    // On form submission
    JFCustomWidget.subscribe('submit', onSubmitForm);
  } else {
    // Local Testing
    window.onload = function() {
      detectEditorMode();
      createSpinnerTable(6, 2);
    };
  }
</script>
</body>
</html>
