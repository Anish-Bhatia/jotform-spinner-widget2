<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Custom Spinner Table Widget</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }

    /* Container for the custom spinner */
    .spinner-container {
      display: inline-flex;
      align-items: center;
    }

    .spinner-btn {
      width: 30px;
      height: 30px;
      background: #333;
      color: #fff;
      border: none;
      cursor: pointer;
      outline: none;
      font-size: 16px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
    }

    .spinner-btn:hover {
      background: #555;
    }

    .spinner-value {
      width: 40px;
      height: 30px;
      text-align: center;
      border: 1px solid #ccc;
      margin: 0 2px;
      outline: none;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <table id="spinnerTable"></table>

  <!-- JotForm Widget Scripts -->
  <script src="https://cdn.jotfor.ms/js/widgetResizer.js"></script>
  <script src="https://cdn.jotfor.ms/JotFormCustomWidget.js"></script>

  <script>
    /**
     * Helper function to create a custom plus/minus spinner element.
     * @param {function} onChange - Called whenever the value changes.
     * @param {number} [defaultValue=0] - Initial numeric value.
     * @param {number} [minValue=null] - Optional minimum value.
     * @param {number} [maxValue=null] - Optional maximum value.
     * @returns {HTMLElement} - The container with minus button, value display, plus button.
     */
    function createCustomSpinner(onChange, defaultValue = 0, minValue = null, maxValue = null) {
      const container = document.createElement('div');
      container.className = 'spinner-container';

      // Minus button
      const minusBtn = document.createElement('button');
      minusBtn.className = 'spinner-btn';
      minusBtn.textContent = '-';

      // Value display (input)
      const valueInput = document.createElement('input');
      valueInput.className = 'spinner-value';
      valueInput.type = 'text';  // or 'number' (but weâ€™ll do text to avoid native spinners)
      valueInput.value = defaultValue;

      // Plus button
      const plusBtn = document.createElement('button');
      plusBtn.className = 'spinner-btn';
      plusBtn.textContent = '+';

      // Decrement function
      minusBtn.addEventListener('click', () => {
        let current = parseInt(valueInput.value, 10) || 0;
        let newVal = current - 1;
        if (minValue !== null && newVal < minValue) {
          newVal = minValue;
        }
        valueInput.value = newVal;
        onChange();
      });

      // Increment function
      plusBtn.addEventListener('click', () => {
        let current = parseInt(valueInput.value, 10) || 0;
        let newVal = current + 1;
        if (maxValue !== null && newVal > maxValue) {
          newVal = maxValue;
        }
        valueInput.value = newVal;
        onChange();
      });

      // Manual change in the input field
      valueInput.addEventListener('change', () => {
        let val = parseInt(valueInput.value, 10) || 0;
        if (minValue !== null && val < minValue) {
          val = minValue;
        }
        if (maxValue !== null && val > maxValue) {
          val = maxValue;
        }
        valueInput.value = val;
        onChange();
      });

      // Build the container
      container.appendChild(minusBtn);
      container.appendChild(valueInput);
      container.appendChild(plusBtn);
      return container;
    }

    /**
     * Builds a table of custom spinners
     * @param {number} rows
     * @param {number} cols
     */
    function createSpinnerTable(rows, cols) {
      const table = document.getElementById('spinnerTable');
      table.innerHTML = '';  // Clear old table

      for (let r = 0; r < rows; r++) {
        const row = table.insertRow();
        for (let c = 0; c < cols; c++) {
          const cell = row.insertCell();
          // Create a custom spinner for each cell
          const spinner = createCustomSpinner(updateFormData, 0, 0, 999);
          cell.appendChild(spinner);
        }
      }

      // Immediately send data after building
      updateFormData();
    }

    /**
     * Collects all spinner values in the table
     * and sends them to JotForm as a 2D array
     */
    function updateFormData() {
      const table = document.getElementById('spinnerTable');
      const values = [];
      for (let i = 0; i < table.rows.length; i++) {
        const rowValues = [];
        for (let j = 0; j < table.rows[i].cells.length; j++) {
          const cell = table.rows[i].cells[j];
          // The spinner-value is the <input> in our custom spinner container
          const input = cell.querySelector('.spinner-value');
          rowValues.push(input.value);
        }
        values.push(rowValues);
      }
      // Send data to JotForm (if we're inside the widget environment)
      if (window.JFCustomWidget && JFCustomWidget.sendData) {
        JFCustomWidget.sendData({
          value: JSON.stringify(values)
        });
      }
    }

    /**
     * Final data submission to JotForm when the form is submitted
     */
    function onSubmitForm() {
      const table = document.getElementById('spinnerTable');
      const values = [];
      for (let i = 0; i < table.rows.length; i++) {
        const rowValues = [];
        for (let j = 0; j < table.rows[i].cells.length; j++) {
          const input = table.rows[i].cells[j].querySelector('.spinner-value');
          rowValues.push(input.value);
        }
        values.push(rowValues);
      }
      // Send final data
      if (window.JFCustomWidget && JFCustomWidget.sendSubmit) {
        JFCustomWidget.sendSubmit({
          value: JSON.stringify(values)
        });
      }
    }

    /**
     * JotForm Widget Subscriptions
     */
    if (window.JFCustomWidget) {
      // Listen for property changes (rows, cols)
      JFCustomWidget.subscribe('properties', function(props) {
        const rows = parseInt(props.rows, 10) || 6; // Default 6 rows
        const cols = parseInt(props.cols, 10) || 2; // Default 2 columns
        createSpinnerTable(rows, cols);
      });

      // Listen for form submission
      JFCustomWidget.subscribe('submit', onSubmitForm);
    } else {
      // If not in the JotForm environment (local testing), just build a default table
      window.onload = function() {
        createSpinnerTable(6, 2); // 6 down, 2 across
      };
    }
  </script>
</body>
</html>
