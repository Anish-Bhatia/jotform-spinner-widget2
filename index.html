<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Custom Spinner Table Widget with Labels</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      vertical-align: top; /* So labels appear above spinners */
    }

    /* Container for the label + spinner */
    .spinner-cell {
      display: flex;
      flex-direction: column; /* Put label on top, spinner below */
      align-items: center;
      justify-content: center;
    }

    /* Tiny label above each spinner */
    .spinner-label {
      font-size: 12px;
      margin-bottom: 4px;
      color: #555;
    }

    /* The plus/minus spinner container */
    .spinner-container {
      display: inline-flex;
      align-items: center;
    }

    .spinner-btn {
      width: 30px;
      height: 30px;
      background: #333;
      color: #fff;
      border: none;
      cursor: pointer;
      outline: none;
      font-size: 16px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
    }

    .spinner-btn:hover {
      background: #555;
    }

    .spinner-value {
      width: 40px;
      height: 30px;
      text-align: center;
      border: 1px solid #ccc;
      margin: 0 2px;
      outline: none;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <table id="spinnerTable"></table>

  <!-- JotForm Widget Scripts -->
  <script src="https://cdn.jotfor.ms/js/widgetResizer.js"></script>
  <script src="https://cdn.jotfor.ms/JotFormCustomWidget.js"></script>

  <script>
    /**
     * Creates a custom plus/minus spinner element with a label (if provided).
     * @param {string} label - The tiny label to show above the spinner (optional).
     * @param {function} onChange - Callback when value changes.
     * @param {number} [defaultValue=0] - Initial numeric value.
     * @param {number} [minValue=0] - Minimum value (optional).
     * @param {number} [maxValue=999] - Maximum value (optional).
     * @returns {HTMLElement} container with label + spinner UI
     */
    function createLabeledSpinner(label, onChange, defaultValue = 0, minValue = 0, maxValue = 999) {
      // Outer container that holds the label and the spinner
      const cellDiv = document.createElement('div');
      cellDiv.className = 'spinner-cell';

      // If there's a label, show it
      if (label) {
        const labelDiv = document.createElement('div');
        labelDiv.className = 'spinner-label';
        labelDiv.textContent = label;
        cellDiv.appendChild(labelDiv);
      }

      // Spinner container
      const spinnerContainer = document.createElement('div');
      spinnerContainer.className = 'spinner-container';

      // Minus button
      const minusBtn = document.createElement('button');
      minusBtn.className = 'spinner-btn';
      minusBtn.textContent = '-';

      // Value display (text input)
      const valueInput = document.createElement('input');
      valueInput.className = 'spinner-value';
      valueInput.type = 'text'; 
      valueInput.value = defaultValue;

      // Plus button
      const plusBtn = document.createElement('button');
      plusBtn.className = 'spinner-btn';
      plusBtn.textContent = '+';

      // Decrement
      minusBtn.addEventListener('click', () => {
        let current = parseInt(valueInput.value, 10) || 0;
        let newVal = current - 1;
        if (newVal < minValue) newVal = minValue;
        valueInput.value = newVal;
        onChange();
      });

      // Increment
      plusBtn.addEventListener('click', () => {
        let current = parseInt(valueInput.value, 10) || 0;
        let newVal = current + 1;
        if (newVal > maxValue) newVal = maxValue;
        valueInput.value = newVal;
        onChange();
      });

      // Manual user input
      valueInput.addEventListener('change', () => {
        let val = parseInt(valueInput.value, 10) || 0;
        if (val < minValue) val = minValue;
        if (val > maxValue) val = maxValue;
        valueInput.value = val;
        onChange();
      });

      // Build the spinner container
      spinnerContainer.appendChild(minusBtn);
      spinnerContainer.appendChild(valueInput);
      spinnerContainer.appendChild(plusBtn);

      // Add to the cell
      cellDiv.appendChild(spinnerContainer);

      return cellDiv;
    }

    /**
     * Builds a table of labeled spinners
     * @param {number} rows
     * @param {number} cols
     * @param {string[]} labelList - Array of labels (row-major order).
     */
    function createSpinnerTable(rows, cols, labelList = []) {
      const table = document.getElementById('spinnerTable');
      table.innerHTML = ''; // Clear old table

      let index = 0; 
      for (let r = 0; r < rows; r++) {
        const row = table.insertRow();
        for (let c = 0; c < cols; c++) {
          const cell = row.insertCell();
          // Use label if we have it
          const label = labelList[index] || '';
          index++;

          // Create a custom spinner with a label
          const spinnerEl = createLabeledSpinner(label, updateFormData, 0, 0, 999);
          cell.appendChild(spinnerEl);
        }
      }

      // Immediately send data after building
      updateFormData();
    }

    /**
     * Collects all spinner values in the table
     * and sends them to JotForm as a 2D array
     */
    function updateFormData() {
      const table = document.getElementById('spinnerTable');
      const values = [];
      for (let i = 0; i < table.rows.length; i++) {
        const rowValues = [];
        for (let j = 0; j < table.rows[i].cells.length; j++) {
          const cell = table.rows[i].cells[j];
          // The spinner-value is the <input> in our custom spinner
          const input = cell.querySelector('.spinner-value');
          rowValues.push(input.value);
        }
        values.push(rowValues);
      }
      // Send data to JotForm if available
      if (window.JFCustomWidget && JFCustomWidget.sendData) {
        JFCustomWidget.sendData({ value: JSON.stringify(values) });
      }
    }

    /**
     * Final data submission to JotForm
     */
    function onSubmitForm() {
      const table = document.getElementById('spinnerTable');
      const values = [];
      for (let i = 0; i < table.rows.length; i++) {
        const rowValues = [];
        for (let j = 0; j < table.rows[i].cells.length; j++) {
          const input = table.rows[i].cells[j].querySelector('.spinner-value');
          rowValues.push(input.value);
        }
        values.push(rowValues);
      }
      // Send final data
      if (window.JFCustomWidget && JFCustomWidget.sendSubmit) {
        JFCustomWidget.sendSubmit({ value: JSON.stringify(values) });
      }
    }

    /**
     * JotForm Widget Subscriptions
     */
    if (window.JFCustomWidget) {
      // Listen for property changes (rows, cols, labels)
      JFCustomWidget.subscribe('properties', function(props) {
        const rows = parseInt(props.rows, 10) || 6; 
        const cols = parseInt(props.cols, 10) || 2; 
        // Split the labels by comma, trim spaces
        const labelList = props.labels
          ? props.labels.split(',').map((lbl) => lbl.trim())
          : [];
        createSpinnerTable(rows, cols, labelList);
      });

      // Listen for form submission
      JFCustomWidget.subscribe('submit', onSubmitForm);
    } else {
      // Local testing outside JotForm
      window.onload = function() {
        // Example default: 6 rows, 2 columns, minimal labeling
        createSpinnerTable(6, 2, ['Label1', 'Label2', 'Label3', 'Label4', 'Label5', 'Label6',
                                  'Label7', 'Label8', 'Label9', 'Label10', 'Label11', 'Label12']);
      };
    }
  </script>
</body>
</html>
